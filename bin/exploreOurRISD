#!/usr/bin/env node
var fs = require('fs');

var through = require('through2');
var ndjson = require('ndjson');
var cheerio = require('cheerio');

var samplePath =
	__dirname +
	'/../sources/our-risd/sample.json';

Capture();
// Report();
// Format();

function Capture () {
	var Env = require('../env.js');
	var OurRISD = require('../sources/our-risd/index.js')();
	
	Env();

	OurRISD.listSource()
		.pipe(toFile(samplePath));

	function toFile (path) {
		var w = fs.createWriteStream(samplePath);

		return through.obj(write, end);

		function write (row, enc, next) {
			w.write(JSON.stringify(row) + '\n');
			next();
		}

		function end () {
			w.end();
			this.push(null);
		}
	}
}


// Format
function Format() {
	fs.createReadStream(samplePath)
		.pipe(ndjson.parse())
		.pipe(Formatter());

	function Formatter () {
        return through.obj(frmtr);

        function frmtr (post, enc, next) {
        	var formatted = {
        		tags: post.tags
        	};

        	var $ = cheerio.load(
        		'<div>' +
        		post.body +
        		'</div>');

            if (post.type === 'text') {
            	formatted.featured_image =
            		$('figure img')
	            		.first()
	            		.attr('src');

	            formatted.thumbnail_image =
	            	formatted.featured_image;

	            $('figure').first().remove();

	            // WebHook WYSIWYG has a
	            // data-type=image on its
	            // inline images.
	            $('figure img')
	            	.each(function (i, el) {
	            		$(this)
	            			.parent()
	            			.attr('data-type', 'image');
	            	});
	            
	            formatted.body = $('div').html();

	            formatted.intro =
	            	$('p')
	            		.first()
	            		.text()
	            		.split('.')
	            		 [0] + '.';

        		formatted.name = post.title;

            }
            else if (post.type === 'photo') {}
        	else if (post.type === 'audio') {}
    		else if (post.type === 'video') {}
    		else if (post.type === 'link') {}

			console.log(formatted);
            this.push(formatted);
            next();
        }
    }
}

// Report
function Report () {
	var tags = [];
	var types = {};
	var count = 0;

	fs.createReadStream(samplePath)
		.pipe(ndjson.parse())
		.on('data', function (d) {
			d.tags.forEach(function (tag) {
				if (tags.indexOf(tag) === -1) {
					tags.push(tag);
				}
			});

			if (d.type in types) {
				types[d.type] += 1;
			}
			else {
				types[d.type] = 1;
			}

			count += 1;
		})
		.on('end', function () {
			console.log('\n\ntags');
			tags.map(function (d) { console.log(d); });
			console.log('\n\ntypes');
			console.log(types);
			console.log('\\count');
			console.log(count);
		});
}

